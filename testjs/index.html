<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Simple Map</title>

    <link rel="stylesheet" href="http://cityworks.cn/arcgis_js_v320_api/arcgis_js_api/library/3.20/3.20/esri/css/esri.css">


    <script src="http://cityworks.cn/arcgis_js_v320_api/arcgis_js_api/library/3.20/3.20/init.js"></script>
    <style>
        html, body, #mapDiv {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
<div id="mapDiv">
    <button onclick="btnClick('zoomin')">放大</button>
    <button onclick="btnClick('zoomout');">缩小</button>
    <button onclick="btnClick('zoomfullext');">全局图</button>
    <button onclick="btnClick('zoomprev');">前一视图</button>
    <button onclick="btnClick('zoomnext');">后一视图</button>
    <button onclick="btnClick('panUp');">向上平移</button>
    <button onclick="btnClick('panDown');">向下平移</button>
    <button onclick="btnClick('panLeft');">向左平移</button>
    <button onclick="btnClick('panRight');">向右平移</button>
    <button onclick="btnClick('magnifier')">放大镜</button>
    <button onclick="btnClick('duiZhong')">对中</button>
    <button id="point" >画点</button>
    <button onclick="MapDraw('polyline')">画线</button>
    <button onclick="MapDraw('circle')">画圆</button>
    <button onclick="MapDraw('extent')">画框</button>
    <button onclick="MapDraw('polygon')">画面</button>
    <button onclick="overViewHash(true)">开启鹰眼图</button>
    <button onclick="overViewHash(false)">关闭鹰眼图</button>
    <button onclick="Querypoint()">点击建筑查询</button>
    <button onclick="MapDraw('close')">关闭绘制</button>
</div>
</body>

<script>


    var map;
    var centerPoint;
    var navToolbar;
    var drawToolbar;
    var doDrawEventHandler;
    var overviewMapDijit;
    var point;
    let graphicsLayer
    require([
            "dojo/on",
            "dojo/dom",
            "esri/map",
            'esri/graphic',
            "esri/layers/GraphicsLayer",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/Color",
            "esri/geometry/Extent",
            "esri/layers/ArcGISTiledMapServiceLayer",
            "esri/toolbars/draw",
            "esri/toolbars/navigation",
            "esri/geometry/Point",
            "esri/dijit/OverviewMap",
        ],
        function (on,dom,Map,Graphic,
                  GraphicsLayer,
                  SimpleFillSymbol,
                  SimpleLineSymbol,
                  SimpleMarkerSymbol,
                  Color,
                  Extent, ArcGISTiledMapServiceLayer, Draw, Navigation, Point,OverviewMap) {

            point = new Point();
            map = new Map("mapDiv", {
                logo: false
            });
            var basemapurl = "http://172.25.10.61:6080/arcgis/rest/services/Vector2013_CGCS2000/MapServer";
            var basemaplayer = new ArcGISTiledMapServiceLayer(basemapurl);
            map.addLayer(basemaplayer);
            map.on("load", function () {
                let extent = map.extent;
                let xmin = extent.xmin;
                let ymin = extent.ymin;
                let xmax = extent.xmax;
                let ymax = extent.ymax;
                centerPoint = new Point((xmax+xmin)/2, (ymax+ymin)/2, map.spatialReference);
                //配置鹰眼图
                // overviewMapDijit = new OverviewMap({map: map, attachTo: "bottom-right",});
                // overviewMapDijit.startup();
                // let mapExtent = new Extent(423920.59649843816, 2881424.5245042956, 427970.2063309932, 2883650.199373602, map.spatialReference);
                // map.setExtent(mapExtent);
                navToolbar = new Navigation(map);
                graphicsLayer =  new GraphicsLayer();
                map.addLayer(graphicsLayer);
                drawToolbar = new esri.toolbars.Draw(map);
                drawToolbar.on("draw-complete", doMeasure);
                // map.resize()
            });



    function btnClick(type) {
        // drawToolbar.deactivate();
        if (type == "zoomin") {
            map.setLevel(map.getLevel() + 1)
        } else if (type == "zoomout") {
            map.setLevel(map.getLevel() - 1)
        } else if (type == "zoomfullext") {
            navToolbar.zoomToFullExtent();
        } else if (type == "zoomprev") {
            navToolbar.zoomToPrevExtent();
        } else if (type == "zoomnext") {
            navToolbar.zoomToNextExtent();
        } else if (type == "panUp") {
            map.panUp();
        } else if (type == "panDown") {
            map.panDown();
        } else if (type == "panLeft") {
            map.panLeft();
        } else if (type == "panRight") {
            map.panRight();
        } else if (type == "magnifier") {
            navToolbar.activate(esri.toolbars.Navigation.ZOOM_IN);
        } else if (type == "duiZhong") {
            map.centerAt(centerPoint);
        }
    }


    /**
     * 清除绘制
     */
    function claerMap() {
        map.graphics.clear();
        drawToolbar.deactivate();
    }

    /**
     * 绘制图形
     * @param type
     * @constructor
     */
    on(dom.byId('point'),'click',
    function () {
        let type = "point"
        navToolbar.deactivate();


        // map.showZoomSlider();
        if (type == "point") {
            drawToolbar.activate(esri.toolbars.Draw.POINT);
        }
        else if (type == "polyline") {
            drawToolbar.activate(esri.toolbars.Draw.POLYLINE);
        }
        else if (type == "polygon") {
            drawToolbar.activate(esri.toolbars.Draw.POLYGON);
        } else if (type == "circle") {
            drawToolbar.activate(esri.toolbars.Draw.CIRCLE);
        } else if (type == "extent") {
            drawToolbar.activate(esri.toolbars.Draw.EXTENT);
        }
    })

    /**
     * 绘制
     * @param gra
     */
    function doMeasure(gra) {
        var geometry = gra.geometry;
        switch (geometry.type) {
            case "point":
                var symbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 10, null, new Color([255, 0, 0, 255]));
                break;
            case "polyline":
                var symbol = new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 2);

                break;
            case "polygon":
                var symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 0, 0]), 2), new dojo.Color([255, 0, 0, 0.25]));
                break;
            case "close":
                claerMap();
                break;
            default:
                var symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 0, 0]), 2), new dojo.Color([255, 0, 0, 0.25]));
                break;
        }
        drawToolbar.deactivate();
        var graphic = new Graphic(geometry, symbol);
        graphicsLayer.add(graphic)
        // map.graphics.clear();
        // map.graphics.add(graphic);

    }


    function Querypoint() {
        // if (doDrawEventHandler != undefined) {
        //     dojo.disconnect(doDrawEventHandler);
        // }
        // drawToolbar.deactivate();
        // drawToolbar.activate(esri.toolbars.Draw.POINT);
        // doDrawEventHandler = drawToolbar.on("draw-end", doQuery);
    }

    function doQuery(gra) {
        var geometry = gra.geometry;
        var symbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE, 10, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 1), new dojo.Color([255, 0, 0, 255]));

        var graphic = new esri.Graphic(geometry, symbol);
        map.graphics.clear();
        map.graphics.add(graphic);

        var queryTask = new esri.tasks.QueryTask("http://172.25.10.61:6080/arcgis/rest/services/building/MapServer/0");
        var query = new esri.tasks.Query();
        query.returnGeometry = true;
        query.outSpatialReference = map.extent.spatialReference;
        query.outFields = ["*"];
        query.geometry = geometry;

        queryTask.execute(query, function (fset) {
            if (fset.features.length == 0) {
                alert("抱歉，没有查询到结果！");
            } else {
                showFeature(fset.features[0]);
            }
        });
    }

    function showFeature(feature) {
        map.graphics.clear();
        var symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 255, 0, 0.5]));
        feature.setSymbol(symbol);

        map.graphics.add(feature);

        var attr = feature.attributes;
        var title = attr["建筑名称"];
        var content = "";
        for (var key in attr) {
            content += `${key}:${attr[key]}<br/>`
        }
        map.infoWindow.setTitle(title);
        map.infoWindow.setContent(content);
        map.infoWindow.show(feature.geometry.getExtent().getCenter(), map.getInfoWindowAnchor(feature.geometry.getExtent().getCenter()));
    }


    function overViewHash(bool) {
        if (bool) {
            overviewMapDijit.show();
        } else {
            overviewMapDijit.hide();
        }
    }
        });
</script>
</html>